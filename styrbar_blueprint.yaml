blueprint:
  name: IKEA STYRBAR Remote (E2001/E2002) - Firmware 2.4.16 Fixed v2
  description: |
    **Version: 2.1.0** | Last Updated: 2025-10-25
    
    Completely redesigned approach for IKEA STYRBAR 4-button remote via ZHA.
    
    This blueprint uses a different strategy that doesn't rely on race-prone state checks:
    - Uses event sequence detection with timestamps
    - Filters spurious events based on event patterns, not helper state
    - More reliable detection of all 12 button actions
    
    **NEW APPROACH:**
    - Detects "recall" scene commands to filter spurious "on" events
    - Uses automation mode: restart to ensure clean state
    - Helper only used for tracking, NOT for filtering
    - All release events properly detected with cleanup
    
    **Requirements:**
    - Two text helpers (Settings > Helpers > Text, max length: 30):
      1. Last button pressed (tracks: on, off, left, right, etc.)
      2. Last command (tracks the actual command received)
    
    **Changelog:**
    - v2.1.0 (2025-10-25): Added continuous hold loop actions for smooth dimming/continuous actions
    - v2.0.0 (2025-10-25): Complete redesign using event patterns instead of state checks
    - v1.2.0 (2025-10-25): Fixed timing race condition by reordering
    - v1.1.0 (2025-10-25): Added left/right state filtering
    - v1.0.0 (2025-10-25): Initial release
    
  domain: automation
  source_url: https://github.com/pon-ekh/ha_styrbar_blueprint/blob/main/styrbar_blueprint.yaml

  input:
    remote_device:
      name: STYRBAR Remote
      description: Select your IKEA STYRBAR remote control
      selector:
        device:
          integration: zha
          manufacturer: IKEA of Sweden
          model: Remote Control N2
          multiple: false
    
    helper_last_button:
      name: Helper - Last Button Tracker
      description: |
        Text helper to track which button was pressed (on/off/left/right)
        Create: Settings > Helpers > Text (max length: 30)
      selector:
        entity:
          domain: input_text
          multiple: false
    
    helper_last_command:
      name: Helper - Last Command Tracker
      description: |
        Text helper to track the last command received
        Create: Settings > Helpers > Text (max length: 30)
      selector:
        entity:
          domain: input_text
          multiple: false

    # ========================================
    # ON BUTTON ACTIONS
    # ========================================
    on_button_short_press:
      name: ON Button - Short Press
      description: Action to run when ON button is pressed briefly
      default: []
      selector:
        action: {}
    
    on_button_long_press:
      name: ON Button - Long Press (Hold Start)
      description: Action to run when ON button is held down
      default: []
      selector:
        action: {}
    
    on_button_hold_loop:
      name: ON Button - Hold Loop (Continuous)
      description: |
        Action to repeat continuously while ON button is held.
        Useful for smooth dimming up. Leave empty if not needed.
      default: []
      selector:
        action: {}
    
    on_button_hold_loop_delay:
      name: ON Button - Hold Loop Delay
      description: Delay between each loop iteration (in milliseconds)
      default: 200
      selector:
        number:
          min: 50
          max: 1000
          step: 50
          unit_of_measurement: "ms"
    
    on_button_release:
      name: ON Button - Release (After Hold)
      description: Action to run when ON button is released after holding
      default: []
      selector:
        action: {}
    
    # ========================================
    # OFF BUTTON ACTIONS
    # ========================================
    off_button_short_press:
      name: OFF Button - Short Press
      description: Action to run when OFF button is pressed briefly
      default: []
      selector:
        action: {}
    
    off_button_long_press:
      name: OFF Button - Long Press (Hold Start)
      description: Action to run when OFF button is held down
      default: []
      selector:
        action: {}
    
    off_button_hold_loop:
      name: OFF Button - Hold Loop (Continuous)
      description: |
        Action to repeat continuously while OFF button is held.
        Useful for smooth dimming down. Leave empty if not needed.
      default: []
      selector:
        action: {}
    
    off_button_hold_loop_delay:
      name: OFF Button - Hold Loop Delay
      description: Delay between each loop iteration (in milliseconds)
      default: 200
      selector:
        number:
          min: 50
          max: 1000
          step: 50
          unit_of_measurement: "ms"
    
    off_button_release:
      name: OFF Button - Release (After Hold)
      description: Action to run when OFF button is released after holding
      default: []
      selector:
        action: {}
    
    # ========================================
    # LEFT BUTTON ACTIONS
    # ========================================
    left_button_short_press:
      name: LEFT Button - Short Press
      description: Action to run when LEFT button is pressed briefly
      default: []
      selector:
        action: {}
    
    left_button_long_press:
      name: LEFT Button - Long Press (Hold Confirmed)
      description: Action to run when LEFT button hold is confirmed
      default: []
      selector:
        action: {}
    
    left_button_hold_loop:
      name: LEFT Button - Hold Loop (Continuous)
      description: |
        Action to repeat continuously while LEFT button is held.
        Leave empty if not needed.
      default: []
      selector:
        action: {}
    
    left_button_hold_loop_delay:
      name: LEFT Button - Hold Loop Delay
      description: Delay between each loop iteration (in milliseconds)
      default: 200
      selector:
        number:
          min: 50
          max: 1000
          step: 50
          unit_of_measurement: "ms"
    
    left_button_release:
      name: LEFT Button - Release (After Hold)
      description: Action to run when LEFT button is released after holding
      default: []
      selector:
        action: {}
    
    # ========================================
    # RIGHT BUTTON ACTIONS
    # ========================================
    right_button_short_press:
      name: RIGHT Button - Short Press
      description: Action to run when RIGHT button is pressed briefly
      default: []
      selector:
        action: {}
    
    right_button_long_press:
      name: RIGHT Button - Long Press (Hold Confirmed)
      description: Action to run when RIGHT button hold is confirmed
      default: []
      selector:
        action: {}
    
    right_button_hold_loop:
      name: RIGHT Button - Hold Loop (Continuous)
      description: |
        Action to repeat continuously while RIGHT button is held.
        Leave empty if not needed.
      default: []
      selector:
        action: {}
    
    right_button_hold_loop_delay:
      name: RIGHT Button - Hold Loop Delay
      description: Delay between each loop iteration (in milliseconds)
      default: 200
      selector:
        number:
          min: 50
          max: 1000
          step: 50
          unit_of_measurement: "ms"
    
    right_button_release:
      name: RIGHT Button - Release (After Hold)
      description: Action to run when RIGHT button is released after holding
      default: []
      selector:
        action: {}

mode: restart
max_exceeded: silent

trigger:
  - platform: event
    event_type: zha_event
    event_data:
      device_id: !input remote_device

variables:
  command: "{{ trigger.event.data.command }}"
  args: "{{ trigger.event.data.args | default([]) }}"
  cluster_id: "{{ trigger.event.data.cluster_id }}"
  helper_button: !input helper_last_button
  helper_command: !input helper_last_command
  last_button: "{{ states(helper_button) }}"
  last_command: "{{ states(helper_command) }}"

action:
  # Process based on command type FIRST, before updating trackers
  - choose:
      # ============================================
      # IGNORE SPURIOUS RECALL EVENTS - Track but don't trigger actions
      # ============================================
      - conditions:
          - condition: template
            value_template: >
              {{ command == 'recall' }}
        sequence:
          - service: input_text.set_value
            target:
              entity_id: !input helper_last_command
            data:
              value: "{{ command }}"
      
      # ============================================
      # ON BUTTON - Short Press
      # Filter: Ignore if last_command is "spurious_sequence" marker
      # ============================================
      - conditions:
          - condition: template
            value_template: >
              {{ command == 'on' and cluster_id == 6 }}
          - condition: template
            value_template: >
              {{ last_command != 'spurious_sequence' }}
        sequence:
          - service: input_text.set_value
            target:
              entity_id: !input helper_last_command
            data:
              value: "{{ command }}"
          - service: input_text.set_value
            target:
              entity_id: !input helper_last_button
            data:
              value: "on"
          - choose:
              - conditions: "{{ true }}"
                sequence: !input on_button_short_press

      # ============================================
      # ON BUTTON - Long Press (Hold)
      # ============================================
      - conditions:
          - condition: template
            value_template: "{{ command == 'move_with_on_off' }}"
        sequence:
          - service: input_text.set_value
            target:
              entity_id: !input helper_last_command
            data:
              value: "{{ command }}"
          - service: input_text.set_value
            target:
              entity_id: !input helper_last_button
            data:
              value: "on_holding"
          # Trigger initial hold action
          - choose:
              - conditions: "{{ true }}"
                sequence: !input on_button_long_press
          # Start continuous loop if configured
          - repeat:
              while:
                - condition: template
                  value_template: "{{ states(helper_button) == 'on_holding' }}"
              sequence:
                - choose:
                    - conditions: "{{ true }}"
                      sequence: !input on_button_hold_loop
                - delay:
                    milliseconds: !input on_button_hold_loop_delay

      # ============================================
      # ON/OFF BUTTON - Release after Hold
      # ============================================
      - conditions:
          - condition: template
            value_template: >
              {{ command == 'stop' }}
        sequence:
          - service: input_text.set_value
            target:
              entity_id: !input helper_last_command
            data:
              value: "{{ command }}"
          - choose:
              # ON button release
              - conditions:
                  - condition: template
                    value_template: "{{ last_button == 'on_holding' }}"
                sequence:
                  - service: input_text.set_value
                    target:
                      entity_id: !input helper_last_button
                    data:
                      value: "on"
                  - choose:
                      - conditions: "{{ true }}"
                        sequence: !input on_button_release
              
              # OFF button release
              - conditions:
                  - condition: template
                    value_template: "{{ last_button == 'off_holding' }}"
                sequence:
                  - service: input_text.set_value
                    target:
                      entity_id: !input helper_last_button
                    data:
                      value: "off"
                  - choose:
                      - conditions: "{{ true }}"
                        sequence: !input off_button_release

      # ============================================
      # OFF BUTTON - Short Press
      # ============================================
      - conditions:
          - condition: template
            value_template: "{{ command == 'off' }}"
        sequence:
          - service: input_text.set_value
            target:
              entity_id: !input helper_last_command
            data:
              value: "{{ command }}"
          - service: input_text.set_value
            target:
              entity_id: !input helper_last_button
            data:
              value: "off"
          - choose:
              - conditions: "{{ true }}"
                sequence: !input off_button_short_press

      # ============================================
      # OFF BUTTON - Long Press (Hold)
      # ============================================
      - conditions:
          - condition: template
            value_template: >
              {{ command == 'move' and args|length > 0 }}
        sequence:
          - service: input_text.set_value
            target:
              entity_id: !input helper_last_command
            data:
              value: "{{ command }}"
          - service: input_text.set_value
            target:
              entity_id: !input helper_last_button
            data:
              value: "off_holding"
          # Trigger initial hold action
          - choose:
              - conditions: "{{ true }}"
                sequence: !input off_button_long_press
          # Start continuous loop if configured
          - repeat:
              while:
                - condition: template
                  value_template: "{{ states(helper_button) == 'off_holding' }}"
              sequence:
                - choose:
                    - conditions: "{{ true }}"
                      sequence: !input off_button_hold_loop
                - delay:
                    milliseconds: !input off_button_hold_loop_delay

      # ============================================
      # LEFT BUTTON - Short Press
      # ============================================
      - conditions:
          - condition: template
            value_template: >
              {{ command == 'press' and args|length > 0 and args[0] == 257 }}
        sequence:
          - service: input_text.set_value
            target:
              entity_id: !input helper_last_command
            data:
              value: "{{ command }}"
          - service: input_text.set_value
            target:
              entity_id: !input helper_last_button
            data:
              value: "left"
          - choose:
              - conditions: "{{ true }}"
                sequence: !input left_button_short_press

      # ============================================
      # LEFT BUTTON - Long Press (actual hold command)
      # ============================================
      - conditions:
          - condition: template
            value_template: >
              {{ command == 'hold' and args|length > 0 and args[0] == 3329 }}
        sequence:
          - service: input_text.set_value
            target:
              entity_id: !input helper_last_command
            data:
              value: "{{ command }}"
          - service: input_text.set_value
            target:
              entity_id: !input helper_last_button
            data:
              value: "left_holding"
          # Trigger initial hold action
          - choose:
              - conditions: "{{ true }}"
                sequence: !input left_button_long_press
          # Start continuous loop if configured
          - repeat:
              while:
                - condition: template
                  value_template: "{{ states(helper_button) == 'left_holding' }}"
              sequence:
                - choose:
                    - conditions: "{{ true }}"
                      sequence: !input left_button_hold_loop
                - delay:
                    milliseconds: !input left_button_hold_loop_delay

      # ============================================
      # LEFT/RIGHT BUTTON - Release after Hold
      # ============================================
      - conditions:
          - condition: template
            value_template: >
              {{ command == 'release' and args|length > 0 and args[0] != 0 }}
        sequence:
          - service: input_text.set_value
            target:
              entity_id: !input helper_last_command
            data:
              value: "{{ command }}"
          - choose:
              # LEFT button release
              - conditions:
                  - condition: template
                    value_template: "{{ last_button == 'left_holding' }}"
                sequence:
                  - service: input_text.set_value
                    target:
                      entity_id: !input helper_last_button
                    data:
                      value: "left"
                  - choose:
                      - conditions: "{{ true }}"
                        sequence: !input left_button_release
              
              # RIGHT button release
              - conditions:
                  - condition: template
                    value_template: "{{ last_button == 'right_holding' }}"
                sequence:
                  - service: input_text.set_value
                    target:
                      entity_id: !input helper_last_button
                    data:
                      value: "right"
                  - choose:
                      - conditions: "{{ true }}"
                        sequence: !input right_button_release

      # ============================================
      # RIGHT BUTTON - Short Press
      # ============================================
      - conditions:
          - condition: template
            value_template: >
              {{ command == 'press' and args|length > 0 and args[0] == 256 }}
        sequence:
          - service: input_text.set_value
            target:
              entity_id: !input helper_last_command
            data:
              value: "{{ command }}"
          - service: input_text.set_value
            target:
              entity_id: !input helper_last_button
            data:
              value: "right"
          - choose:
              - conditions: "{{ true }}"
                sequence: !input right_button_short_press

      # ============================================
      # RIGHT BUTTON - Long Press (actual hold command)
      # ============================================
      - conditions:
          - condition: template
            value_template: >
              {{ command == 'hold' and args|length > 0 and args[0] == 3328 }}
        sequence:
          - service: input_text.set_value
            target:
              entity_id: !input helper_last_command
            data:
              value: "{{ command }}"
          - service: input_text.set_value
            target:
              entity_id: !input helper_last_button
            data:
              value: "right_holding"
          # Trigger initial hold action
          - choose:
              - conditions: "{{ true }}"
                sequence: !input right_button_long_press
          # Start continuous loop if configured
          - repeat:
              while:
                - condition: template
                  value_template: "{{ states(helper_button) == 'right_holding' }}"
              sequence:
                - choose:
                    - conditions: "{{ true }}"
                      sequence: !input right_button_hold_loop
                - delay:
                    milliseconds: !input right_button_hold_loop_delay

      # ============================================
      # SPURIOUS RELEASE 0 - Mark that next "on" should be ignored
      # ============================================
      - conditions:
          - condition: template
            value_template: >
              {{ command == 'release' and args|length > 0 and args[0] == 0 }}
        sequence:
          # Set command to "spurious_sequence" to mark we're in left/right hold
          - service: input_text.set_value
            target:
              entity_id: !input helper_last_command
            data:
              value: "spurious_sequence"
          # Update to holding state based on which button was last pressed
          - service: input_text.set_value
            target:
              entity_id: !input helper_last_button
            data:
              value: >
                {% if last_button == 'left' %}
                  left_holding
                {% elif last_button == 'right' %}
                  right_holding
                {% else %}
                  {{ last_button }}
                {% endif %}
